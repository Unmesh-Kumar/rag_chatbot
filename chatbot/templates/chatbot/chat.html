<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RAG Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col items-center min-h-screen">

    <div class="w-full max-w-2xl flex flex-col p-6 bg-white shadow-md mt-10 mb-10 rounded-lg">
        <h1 class="text-2xl font-bold mb-4 text-center">üß† Angel One RAG Chatbot</h1>

        <!-- Chat Box -->
        <div id="chat-box" class="h-[70vh] overflow-y-auto space-y-4 p-4 bg-gray-50 border rounded-lg flex flex-col">
            <!-- Chat messages will appear here -->
        </div>

        <!-- Input Form -->
        <form id="chat-form" class="flex mt-4 space-x-2">
            <input id="user-input" type="text" required
                   placeholder="Ask a question..."
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring focus:border-blue-300" />
            <button type="submit"
                    class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition">
                Send
            </button>
        </form>
    </div>

    <!-- JavaScript -->
    <script>
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');

        function appendMessage(sender, message) {
            const wrapper = document.createElement('div');
            wrapper.classList.add('flex', 'items-start', 'space-x-2');

            const bubble = document.createElement('div');
            bubble.classList.add('px-4', 'py-2', 'rounded-lg', 'max-w-[75%]', 'whitespace-pre-wrap', 'text-sm', 'shadow');

            const avatar = document.createElement('div');
            avatar.classList.add('text-xl');

            if (sender === 'user') {
                wrapper.classList.add('justify-end');
                avatar.textContent = 'üßë';
                wrapper.appendChild(bubble);
                wrapper.appendChild(avatar);
                bubble.classList.add('bg-blue-100', 'text-gray-800');
                bubble.innerHTML = message;
            } else {
                wrapper.classList.add('justify-start');
                avatar.textContent = 'ü§ñ';
                wrapper.appendChild(avatar);
                wrapper.appendChild(bubble);
                bubble.classList.add('bg-green-100', 'text-gray-800');
                bubble.innerHTML = message;
            }

            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = userInput.value.trim();
            if (!question) return;

            appendMessage('user', question);
            userInput.value = '';

            try {
                const response = await fetch('/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ question })
                });
                const data = await response.json();
                appendMessage('bot', data.answer);
            } catch (error) {
                appendMessage('bot', "‚ùå Sorry, something went wrong.");
            }
        });

        function getCSRFToken() {
            const name = 'csrftoken';
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [key, value] = cookie.trim().split('=');
                if (key === name) return decodeURIComponent(value);
            }
            return '';
        }
    </script>

</body>
</html>